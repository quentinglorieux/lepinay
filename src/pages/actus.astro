---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).sort((a,b)=>
  new Date(b?.data?.date || '1970-01-01').getTime() - new Date(a?.data?.date || '1970-01-01').getTime()
);
const list = posts.map(p => {
  const cover = typeof p?.data?.cover === 'string'
    ? p.data.cover
    : (typeof p?.data?.image === 'string' ? p.data.image : p?.data?.image?.src);
  const dateStr = p?.data?.date ? new Date(p.data.date).toLocaleDateString('fr-FR') : '';
  return {
    slug: p.id,
    title: p.data.title,
    subtitle: p.data.subtitle || '',
    city: p.data.city || '',
    cover,
    dateStr,
    categories: p.data.categories || [],
    tags: p.data.tags || []
  };
});
---
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Actualités</title>
  </head>
  <body>
    <Header />
    <main class="container">
      <h1 id="list-title">Actualités</h1>
      <div class="grid posts-grid">
        {list.map((p) => (
          <article class="post-card" data-tags={p.tags.map((t)=>t.toLowerCase()).join(',')}>
            <a href={`/actus/${p.slug}`} aria-label={p.title}>
              {p.cover && <img class="post-cover" src={p.cover} alt={p.title} loading="lazy" />}
              <h3 class="post-title">{p.title}</h3>
              {p.subtitle && <div class="post-subtitle">{p.subtitle}</div>}
              <div class="post-meta">
                {p.dateStr && <span>{p.dateStr}</span>}
                {p.city && <span class="sep">•</span>}
                {p.city && <span style="font-weight: 500;">{p.city}</span>}
              </div>
            </a>
          </article>
        ))}
      </div>
    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const tag = (params.get('tag') || '').toLowerCase().trim();
        if (!tag) return;

        const grid = document.querySelector('.posts-grid');
        const title = document.getElementById('list-title');
        if (title) {
          const cap = tag.charAt(0).toUpperCase() + tag.slice(1);
          title.textContent = 'Actualités — ' + cap;
        }

        let count = 0;
        grid?.querySelectorAll('.post-card').forEach((el) => {
          const tags = (el.getAttribute('data-tags') || '').split(',').map(s => s.trim());
          const match = tag && tags.includes(tag);
          el.style.display = match ? '' : 'none';
          if (match) count++;
        });

        if (count === 0 && grid) {
          const empty = document.createElement('p');
          empty.textContent = 'Aucun article pour ce tag.';
          empty.style.color = 'var(--muted)';
          empty.style.marginTop = '8px';
          grid.appendChild(empty);
        }
      });
    </script>
      <div class="all-tags">
        <h2>Tags</h2>
        <div class="tags-list">
          {Array.from(new Set(list.flatMap(p => p.tags))).map(tag => (
            <a href={`/actus?tag=${encodeURIComponent(tag)}`} class="tag">#{tag}</a>
          ))}
        </div>
      </div>
    </main>
    <Footer />

    <style>
      .all-tags { margin-top: 2rem; }
      .all-tags h2 { font-size:1.2rem; margin-bottom:0.5rem; }
      .tags-list { display:flex; flex-wrap:wrap; gap:8px; }
      .tag { font-size:.9rem; border:1px solid var(--accent); padding:2px 8px; border-radius:12px; color:var(--fg); text-decoration:none; }
      .tag:hover { background:var(--overlay); }
    </style>

  </body>
</html>