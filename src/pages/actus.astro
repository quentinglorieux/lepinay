---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).sort((a,b)=>
  new Date(b?.data?.date || '1970-01-01').getTime() - new Date(a?.data?.date || '1970-01-01').getTime()
);
const list = posts.map(p => {
  const cover = typeof p?.data?.cover === 'string'
    ? p.data.cover
    : (typeof p?.data?.image === 'string' ? p.data.image : p?.data?.image?.src);
  const dateStr = p?.data?.date ? new Date(p.data.date).toLocaleDateString('fr-FR') : '';
  return {
    slug: p.id,
    title: p.data.title,
    subtitle: p.data.subtitle || '',
    city: p.data.city || '',
    cover,
    dateStr,
    categories: p.data.categories || [],
    tags: p.data.tags || []
  };
});
---
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Actualités</title>
  </head>
  <body>
    <Header />
    <main class="container">
      <h1>Actualités</h1>
      <div class="grid posts-grid">
        {list.map((p) => (
          <article class="post-card">
            <a href={`/actus/${p.slug}`} aria-label={p.title}>
              {p.cover && <img class="post-cover" src={p.cover} alt={p.title} loading="lazy" />}
              <h3 class="post-title">{p.title}</h3>
              {p.subtitle && <div class="post-subtitle">{p.subtitle}</div>}
              <div class="post-meta">
                {p.dateStr && <span>{p.dateStr}</span>}
                {p.city && <span class="sep">•</span>}
                {p.city && <span style="font-weight: 500;">{p.city}</span>}
              </div>
            </a>
          </article>
        ))}
      </div>
    </main>
    <Footer />

  </body>
</html>